@model PTT_NGROUR.Models.ViewModel.ModelRisk

@{
    ViewBag.Title = "Risk Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
    PTT_NGROUR.Models.User users = new PTT_NGROUR.Models.User();
    @Html.Hidden("username", users.Username);
    @Html.Hidden("flag", users.Roleid);
}

@section style{
    <link href="~/Scripts/bootstrap-select-1.12.4/dist/css/bootstrap-select.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap-datepicker.css" rel="stylesheet" />
}


<style>
    .tableFixHead {
        overflow-y: auto;
        height: 425px;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th {
        background: white;
    }

    .accordion {
        background-color: #d9edf7;
        color: #31708f;
        cursor: pointer;
        padding: 10px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
    }

        .active, .accordion:hover {
            background-color: #bce8f1;
        }

        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }

    .active:after {
        content: "\2212";
    }
</style>
<br />
<div class="container-fluid" style="margin-top:-.8rem">
    <div class="ph2 ph0-xs">
        <div class="p-3 mb-2 mv2 col-container-white text-dark">
            <!--Search Bar -->
            <div class="ph2 pv2">
                <div class="row">
                    <div class="col-md-4 text-right">
                        <div class="form-control-static">
                            <label class="radio-inline">
                                <input type="radio" name="radioMode" id="radioModeRisk" value="risk"> Risk
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="radioMode" id="radioModeRegion" value="region"> Region
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="radioMode" id="radioModeLicense" value="license"> License
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <select class="selectpicker form-control" name="region" id="selectRegion" data-target="region" multiple data-selected-text-format="count" data-live-search="true" data-actions-box="true" style="margin-bottom:-1rem;" disabled>
                                @foreach (PTT_NGROUR.Models.DataModel.ModelRegion ml in Model.ListRegion)
                                {
                                    <option value="@ml.REGION_ID" class="text-grey" style="word-wrap:break-word; font-size:15px" selected>@ml.REGION_NAME</option>
                                }
                            </select>
                            <select class="selectpicker form-control" name="license" id="selectLicense" data-target="license" multiple data-selected-text-format="count" data-live-search="true" data-actions-box="true" style="margin-bottom:-1rem;">
                                @foreach (PTT_NGROUR.Models.DataModel.ModelLicenseMaster ml in Model.ListLicense)
                                {
                                    <option value="@ml.LICENSE_ID" class="text-grey" style="word-wrap:break-word; font-size:15px" selected>@ml.LICENSE</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <div class="input-group">
                                <input type="text" class="form-control" id="datePicker" data-datepicker />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary rounded-0" onclick="onSubmit()">
                            <span class="glyphicon glyphicon-search"></span> Search
                        </button>
                        <a href="@Url.Action("AcceptanceCriteria", "Risk")" class="btn btn-default rounded-0">
                            <span class="glyphicon glyphicon-cog"></span>
                        </a>
                    </div>
                </div>
            </div>
            <!--Search Bar -->

            <div class="ph2 pv2">
                <div class="row">
                    <div class="col-md-6">
                        <iframe src="@System.Web.Configuration.WebConfigurationManager.AppSettings["DashboardMap"]" style="min-height: 500px; height: 100% !important; width: 100% !important; border-width: 0px" id="map_frame"></iframe>
                    </div>
                    <div class="col-md-6">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pt-15px pb-15px pr-0 pl-0 border-left-md border-left-lg" style="float:none">
                            <div class="form-inline">
                                <center>
                                    <div class="input-group" style="z-index:0!important">
                                        <div class="input-group-btn col-lg-1 col-md-6 col-sm-6 col-xs-6 fn-xs" style="padding-left:0rem;padding-right:0rem;">
                                            <input id="txtRiskSearch" class="form-control input-sm" type="text" aria-describedby="name-desc" placeholder="Search by RC Name" onkeyup="RiskTableSearch()">
                                        </div>
                                        <div class="input-group-btn col-lg-1 col-md-3 col-sm-3 col-xs-3 fn-xs" style="padding-left:0rem;padding-right:0rem;">

                                            <select class="form-control form-control-sm fz-12px" id="risk-threshold-filter" style="height: 30px !important;">
                                                <option id="seAllThres" class="fz-12px drop_role" value="all">All Threshold</option>
                                                <option id="seRisk" class="fz-12px drop_role" value="risk">Risk</option>
                                                <option id="seNoRisk" class="fz-12px drop_role" value="norisk">No Risk</option>
                                            </select>
                                        </div>
                                        <!--<div class="cr"></div>-->
                                    </div>
                                </center>
                            </div>
                            <br />

                            <div class="table-responsive " id="TableRisk">
                                <div class="tableFixHead" id="dashtbtRisk">
                                    <table class=" table table-striped table-hover table-bordered" id="riskTbl">
                                        <thead style="position: relative; z-index: 1;">
                                            <tr>
                                                <th>Region</th>
                                                <th>RC</th>
                                                <th>Risk Score</th>
                                                <th>Internal Corrosion</th>
                                                <th>External Corrosion</th>
                                                <th>Third Party Interference</th>
                                                <th>Loss of Ground Support</th>
                                                <th>Import</th>
                                                <th>View File</th>
                                            </tr>
                                        </thead>
                                        <tbody class="scrollable-height scrollable-height-lg">
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="~/Scripts/bootstrap-select-1.12.4/dist/js/bootstrap-select.min.js"></script>
    <script src="~/Content/bootstrap-datepicker.js"></script>
    <script src="~/Scripts/lodash.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="~/Scripts/lodash.js"></script>

    <script type="text/javascript">
        $('.tableFixHead').on('scroll', function () {
            $('thead', this).css('transform', 'translateY(' + this.scrollTop + 'px)');
        });

        $('[data-datepicker]').datepicker({
            format: "MM yyyy",
            viewMode: "months",
            minViewMode: "months",
            autoclose: true,
            inline: true,
        }).datepicker("setDate", new Date());

        $('#radioModeRisk').prop('checked', true)
        $('select[data-target]').on('loaded.bs.select', function () {
            if ($('[name="radioMode"]:checked').val() !== $(this).data('target')) {
                $(this).prop('disabled', true).parent('.bootstrap-select').hide()
            }
            if ($('[name="radioMode"]:checked').val() === 'risk' && $(this).data('target') === 'region') {
                $(this).parent('.bootstrap-select').show()
            }
        });

        $('[name="radioMode"]').on('change', function (e) {
            var val = $(this).val()

            $('select[data-target]').prop('disabled', true)
            var select = $('select[data-target="' + val + '"]')
            if (select.length > 0) {
                $('select[data-target]').parent('.bootstrap-select').hide()
                select.prop('disabled', false).parent('.bootstrap-select').show()
            }

            $('.selectpicker').selectpicker('refresh');
        })

        function onSubmit() {
            getRiskJson()
        }

        function showRiskTable(data) {
            console.log(data)
            $('#risk-threshold-filter').val('all');
            $('#riskTbl').find('tbody tr').each(function () {
                $(this).remove();
            });

            $('#txtRiskSearch').val("");

            _.forEach(data, function (o) {
                var tds = '';
                var isRisk = _.includes(Object.values(o), 'RISK');
                var style = '';

                if (isRisk) style = 'color:#e74c3c'

                tds = tds + '<td>' + o.REGION + '</td>';
                tds = tds + '<td style="' + style + '">' + o.RC_NAME + '</td>';

                var key = ['RISK_SCORE', 'INTERNAL_CORROSION', 'EXTERNAL_CORROSION', 'THIRD_PARTY_INTERFERENCE', 'LOSS_OF_GROUND_SUPPORT'];
                _.forEach(key, function (v) {
                    let bullet = ''

                    if (o[v + '_RISK'] === 'RISK') {
                        bullet = '<span class="fa fa-circle" style="color:#e74c3c;"></span>'
                    }
                    tds = tds + '<td class="text-center">' + bullet + '</td>';
                });

                tds = tds + '<td><button class="btn btn-success" onclick="onImport("' + o.RC_NAME + '")"><span class="glyphicon glyphicon-paperclip"></span></button></td>';
                tds = tds + '<td><button class="btn btn-info" onclick="onView("' + o.RC_NAME + '")"><span class="glyphicon glyphicon-eye-open"></span></button></td>';

                $('#riskTbl > tbody:last-child').append('<tr id="' + o.RC_NAME + '" data-status="' + (isRisk ? 'risk' : 'norisk') + '" class="rowfilRisk pointer">' + tds + '</tr>');
            });
        }

        var getRiskJson = function () {
            var mode = $('[name="radioMode"]:checked').val();
            var date = $("#datePicker").datepicker("getDate");
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            axios.post('/Risk/Json', {
                type: mode,
                lists: $('[data-target="' + mode + '"]').val(),
                month: month,
                year: year
            })
                .then(function (response) {
                    data = response.data
                    showRiskTable(data)
                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                })
                .then(function () {
                    // always executed
                });
        }

        getRiskJson();
    </script>
}